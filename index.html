<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Междугородние поездки</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
</head>
<body className="bg-gray-100">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const routes = [
      'Караганда – Астана', 'Караганда – Щучинск', 'Караганда – Бурабай',
      'Астана – Караганда', 'Щучинск – Караганда', 'Бурабай – Караганда'
    ];

    const App = () => {
      const [userType, setUserType] = useState('passenger'); // passenger or driver
      const [trips, setTrips] = useState([]);
      const [phone, setPhone] = useState('');
      const [route, setRoute] = useState('');
      const [date, setDate] = useState('');
      const [time, setTime] = useState('');
      const [price, setPrice] = useState('');
      const [seats, setSeats] = useState('');
      const [car, setCar] = useState('');
      const [driverName, setDriverName] = useState('');
      const [pickupAddress, setPickupAddress] = useState('');
      const [selectedSeat, setSelectedSeat] = useState(null);
      const [filterTime, setFilterTime] = useState('');
      const [filterPrice, setFilterPrice] = useState('');
      const [bookings, setBookings] = useState([]);
      const [reviews, setReviews] = useState([]);
      const [adminView, setAdminView] = useState(false);

      // Моковые данные
      useEffect(() => {
        const mockTrips = [
          {
            id: 1, route: 'Караганда – Астана', date: '2025-06-17', time: '10:00', price: 5000, seats: 4, availableSeats: 3,
            car: 'Toyota Camry', driver: { name: 'Айдос', phone: '+77012345678', experience: 5, trips: 20, rating: 4.5 },
            passengers: [{ phone: '+77098765432', seat: 1 }],
            distance: '220 км', duration: '3 ч'
          },
          {
            id: 2, route: 'Бурабай – Караганда', date: '2025-06-18', time: '14:00', price: 7000, seats: 4, availableSeats: 1,
            car: 'Hyundai Sonata', driver: { name: 'Нурлан', phone: '+77087654321', experience: 3, trips: 10, rating: 4.0 },
            passengers: [{ phone: '+77012345679', seat: 2 }, { phone: '+77012345680', seat: 3 }, { phone: '+77012345681', seat: 4 }],
            distance: '250 км', duration: '3.5 ч'
          }
        ];
        setTrips(mockTrips);
        setReviews([
          { tripId: 1, rating: 5, comment: 'Отличный водитель, комфортная поездка!' },
          { tripId: 2, rating: 4, comment: 'Все хорошо, но немного опоздали.' }
        ]);
      }, []);

      // Функция для проверки номера телефона (заглушка для SMS)
      const verifyPhone = async (phoneNumber) => {
        // Имитация SMS-подтверждения через Twilio
        console.log(`Отправка SMS на ${phoneNumber}...`);
        return true; // Мок: всегда успешно
      };

      // Добавление поездки водителем
      const addTrip = async () => {
        if (!(await verifyPhone(phone))) {
          alert('Ошибка проверки номера телефона');
          return;
        }
        const newTrip = {
          id: trips.length + 1,
          route,
          date,
          time,
          price: parseInt(price),
          seats: parseInt(seats),
          availableSeats: parseInt(seats),
          car,
          driver: { name: driverName, phone, experience: 0, trips: 0, rating: 0 },
          passengers: [],
          distance: route.includes('Астана') ? '220 км' : '250 км',
          duration: route.includes('Астана') ? '3 ч' : '3.5 ч'
        };
        setTrips([...trips, newTrip]);
        alert('Поездка добавлена!');
      };

      // Бронирование места пассажиром
      const bookSeat = async (tripId, seat) => {
        if (!(await verifyPhone(phone))) {
          alert('Ошибка проверки номера телефона');
          return;
        }
        const updatedTrips = trips.map((trip) => {
          if (trip.id === tripId && trip.availableSeats > 0) {
            return {
              ...trip,
              availableSeats: trip.availableSeats - 1,
              passengers: [...trip.passengers, { phone, seat, address: pickupAddress }]
            };
          }
          return trip;
        });
        setTrips(updatedTrips);
        setBookings([...bookings, { tripId, phone, seat, address: pickupAddress, status: 'confirmed' }]);
        alert(`Бронь на место ${seat} подтверждена! Уведомление отправлено через WhatsApp/Telegram.`);
      };

      // Добавление отзыва
      const addReview = (tripId, rating, comment) => {
        setReviews([...reviews, { tripId, rating, comment }]);
        alert('Отзыв добавлен!');
      };

      // Фильтрация поездок
      const filteredTrips = trips.filter((trip) => {
        return (
          (!route || trip.route === route) &&
          (!filterTime || trip.time.includes(filterTime)) &&
          (!filterPrice || trip.price <= parseInt(filterPrice))
        );
      });

      // Расчет рейтинга водителя
      const getDriverRating = (driverPhone) => {
        const driverReviews = reviews.filter((r) => trips.find((t) => t.id === r.tripId && t.driver.phone === driverPhone));
        return driverReviews.length
          ? (driverReviews.reduce((sum, r) => sum + r.rating, 0) / driverReviews.length).toFixed(1)
          : 0;
      };

      // Компонент карты (заглушка)
      const Map = ({ route }) => (
        <div className="h-64 bg-gray-200 rounded-lg flex items-center justify-center">
          <p>Карта маршрута {route} (Google Maps API)</p>
        </div>
      );

      // Компонент схемы мест
      const SeatMap = ({ trip, onSelectSeat }) => (
        <div className="grid grid-cols-2 gap-2">
          {Array.from({ length: trip.seats }, (_, i) => {
            const isTaken = trip.passengers.some((p) => p.seat === i + 1);
            return (
              <button
                key={i}
                onClick={() => !isTaken && onSelectSeat(i + 1)}
                className={`p-2 rounded ${isTaken ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`}
                disabled={isTaken}
              >
                Место {i + 1}
              </button>
            );
          })}
        </div>
      );

      // Компонент профиля водителя
      const DriverProfile = ({ driver, tripsCount }) => (
        <div className="bg-white p-4 rounded-lg shadow">
          <img src="https://via.placeholder.com/100" alt="Driver" className="w-24 h-24 rounded-full mx-auto" />
          <p><strong>Имя:</strong> {driver.name}</p>
          <p><strong>Стаж:</strong> {driver.experience} лет</p>
          <p><strong>Авто:</strong> {trips.find((t) => t.driver.phone === driver.phone)?.car}</p>
          <p><strong>Поездок:</strong> {tripsCount}</p>
          <p><strong>Рейтинг:</strong> {getDriverRating(driver.phone)}</p>
        </div>
      );

      return (
        <div className="min-h-screen flex flex-col">
          <header className="bg-blue-600 text-white py-4">
            <div className="container mx-auto px-4 flex justify-between">
              <h1 className="text-2xl font-bold">Междугородние поездки</h1>
              <div>
                <button
                  onClick={() => setUserType(userType === 'passenger' ? 'driver' : 'passenger')}
                  className="mr-4"
                >
                  {userType === 'passenger' ? 'Режим водителя' : 'Режим пассажира'}
                </button>
                <button onClick={() => setAdminView(!adminView)}>
                  {adminView ? 'Выход из админки' : 'Админ-панель'}
                </button>
              </div>
            </div>
          </header>
          <main className="container mx-auto py-8 px-4 flex-grow">
            {adminView ? (
              <div>
                <h2 className="text-xl font-semibold mb-4">Панель администратора</h2>
                <p><strong>Статистика:</strong> {bookings.length} бронирований за день</p>
                <h3 className="text-lg font-semibold mt-4">Поездки</h3>
                {trips.map((trip) => (
                  <div key={trip.id} className="bg-white p-4 rounded-lg shadow mb-4">
                    <p><strong>Маршрут:</strong> {trip.route}</p>
                    <p><strong>Водитель:</strong> {trip.driver.name}</p>
                    <button
                      onClick={() => setTrips(trips.filter((t) => t.id !== trip.id))}
                      className="text-red-500"
                    >
                      Удалить
                    </button>
                  </div>
                ))}
              </div>
            ) : userType === 'driver' ? (
              <div className="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-md">
                <h2 className="text-xl font-semibold mb-4">Добавить поездку</h2>
                <div className="space-y-4">
                  <input
                    type="text"
                    placeholder="Номер телефона"
                    value={phone}
                    onChange={(e) => setPhone(e.target.value)}
                    className="w-full p-2 border rounded"
                  />
                  <select
                    value={route}
                    onChange={(e) => setRoute(e.target.value)}
                    className="w-full p-2 border rounded"
                  >
                    <option value="">Выберите маршрут</option>
                    {routes.map((r) => (
                      <option key={r} value={r}>{r}</option>
                    ))}
                  </select>
                  <input
                    type="date"
                    value={date}
                    onChange={(e) => setDate(e.target.value)}
                    className="w-full p-2 border rounded"
                  />
                  <input
                    type="time"
                    value={time}
                    onChange={(e) => setTime(e.target.value)}
                    className="w-full p-2 border rounded"
                  />
                  <input
                    type="number"
                    placeholder="Цена (KZT)"
                    value={price}
                    onChange={(e) => setPrice(e.target.value)}
                    className="w-full p-2 border rounded"
                  />
                  <input
                    type="number"
                    placeholder="Количество мест"
                    value={seats}
                    onChange={(e) => setSeats(e.target.value)}
                    className="w-full p-2 border rounded"
                  />
                  <input
                    type="text"
                    placeholder="Автомобиль"
                    value={car}
                    onChange={(e) => setCar(e.target.value)}
                    className="w-full p-2 border rounded"
                  />
                  <input
                    type="text"
                    placeholder="Имя водителя"
                    value={driverName}
                    onChange={(e) => setDriverName(e.target.value)}
                    className="w-full p-2 border rounded"
                  />
                  <button
                    onClick={addTrip}
                    className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700"
                  >
                    Добавить поездку
                  </button>
                </div>
              </div>
            ) : (
              <div>
                <div className="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-md mb-8">
                  <h2 className="text-xl font-semibold mb-4">Найти поездку</h2>
                  <div className="space-y-4">
                    <input
                      type="text"
                      placeholder="Номер телефона"
                      value={phone}
                      onChange={(e) => setPhone(e.target.value)}
                      className="w-full p-2 border rounded"
                    />
                    <select
                      value={route}
                      onChange={(e) => setRoute(e.target.value)}
                      className="w-full p-2 border rounded"
                    >
                      <option value="">Выберите маршрут</option>
                      {routes.map((r) => (
                        <option key={r} value={r}>{r}</option>
                      ))}
                    </select>
                    <input
                      type="time"
                      placeholder="Время"
                      value={filterTime}
                      onChange={(e) => setFilterTime(e.target.value)}
                      className="w-full p-2 border rounded"
                    />
                    <input
                      type="number"
                      placeholder="Макс. цена (KZT)"
                      value={filterPrice}
                      onChange={(e) => setFilterPrice(e.target.value)}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                </div>
                <h2 className="text-xl font-semibold mb-4">Доступные поездки</h2>
                {filteredTrips.length > 0 ? (
                  <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                    {filteredTrips.map((trip) => (
                      <div key={trip.id} className="bg-white p-4 rounded-lg shadow">
                        <p><strong>Маршрут:</strong> {trip.route}</p>
                        <p><strong>Дата:</strong> {trip.date}</p>
                        <p><strong>Время отправления:</strong> {trip.time}</p>
                        <p><strong>Цена:</strong> {trip.price} KZT</p>
                        <p><strong>Свободных мест:</strong> {trip.availableSeats === 0 ? 'Мест нет' : trip.availableSeats}</p>
                        <p><strong>Авто:</strong> {trip.car}</p>
                        <p><strong>Водитель:</strong> {trip.driver.name}</p>
                        <p><strong>Расстояние:</strong> {trip.distance}</p>
                        <p><strong>Время в пути:</strong> {trip.duration}</p>
                        <Map route={trip.route} />
                        <DriverProfile driver={trip.driver} tripsCount={trips.filter((t) => t.driver.phone === trip.driver.phone).length} />
                        <h3 className="text-lg font-semibold mt-4">Выбор места</h3>
                        <input
                          type="text"
                          placeholder="Адрес посадки"
                          value={pickupAddress}
                          onChange={(e) => setPickupAddress(e.target.value)}
                          className="w-full p-2 border rounded mt-2"
                        />
                        <SeatMap trip={trip} onSelectSeat={(seat) => setSelectedSeat({ tripId: trip.id, seat })} />
                        {trip.availableSeats > 0 && selectedSeat && selectedSeat.tripId === trip.id && (
                          <button
                            onClick={() => bookSeat(trip.id, selectedSeat.seat)}
                            className="w-full bg-blue-600 text-white p-2 rounded mt-2 hover:bg-blue-700"
                          >
                            Забронировать место {selectedSeat.seat}
                          </button>
                        )}
                        <h3 className="text-lg font-semibold mt-4">Отзывы</h3>
                        {reviews.filter((r) => r.tripId === trip.id).map((review, i) => (
                          <div key={i} className="mt-2">
                            <p><strong>Рейтинг:</strong> {review.rating} ★</p>
                            <p>{review.comment}</p>
                          </div>
                        ))}
                        <div className="mt-4">
                          <h4 className="text-lg font-semibold">Оставить отзыв</h4>
                          <select
                            onChange={(e) => {
                              const rating = parseInt(e.target.value);
                              const comment = prompt('Введите комментарий:');
                              if (comment) addReview(trip.id, rating, comment);
                            }}
                            className="w-full p-2 border rounded"
                          >
                            <option value="">Выберите рейтинг</option>
                            {[1, 2, 3, 4, 5].map((r) => (
                              <option key={r} value={r}>{r} ★</option>
                            ))}
                          </select>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-gray-600">Нет доступных поездок</p>
                )}
              </div>
            )}
          </main>
          <footer className="bg-gray-800 text-white py-4">
            <div className="container mx-auto px-4 text-center">
              <p>© 2025 Междугородние поездки</p>
            </div>
          </footer>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
